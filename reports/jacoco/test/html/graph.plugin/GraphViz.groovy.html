<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GraphViz.groovy</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">graph-dsl</a> &gt; <a href="index.source.html" class="el_package">graph.plugin</a> &gt; <span class="el_source">GraphViz.groovy</span></div><h1>GraphViz.groovy</h1><pre class="source lang-java linenums">package graph.plugin

import graph.Edge
import graph.Graph
import graph.Vertex
import groovy.transform.Memoized
import groovy.transform.PackageScope

import javax.imageio.ImageIO
import javax.imageio.stream.FileImageOutputStream
import java.awt.Color
import java.awt.Graphics2D
import java.awt.image.BufferedImage
import java.nio.file.Files
import java.nio.file.Path

class GraphViz implements Plugin {
    Graph graph
<span class="fc" id="L19">    List&lt;BufferedImage&gt; snapshots = []</span>

    @Override
    void apply(Graph graph) {
<span class="fc" id="L23">        this.graph = graph</span>
    }

    @PackageScope
    String getEdgeString() {
<span class="pc bfc" id="L28" title="All 2 branches covered.">        graph.isDirected() ? '-&gt;' : '--'</span>
    }

    @PackageScope
    String getGraphString() {
<span class="pc bpc" id="L33" title="1 of 4 branches missed.">        &quot;${graph.isMultiGraph() ? '' : 'strict'} ${graph.isDirected() ? 'digraph' : 'graph'}&quot;</span>
    }

    @Memoized
    @PackageScope
    String getId(String id) {
<span class="fc bfc" id="L39" title="All 2 branches covered.">        if(id ==~ '[-]?(.[0-9]+|[0-9]+(.[0-9]*)? )') {</span>
<span class="pc" id="L40">            return id</span>
<span class="fc bfc" id="L41" title="All 2 branches covered.">        } else if(id ==~ '[_a-zA-Z\200-\377][_0-9a-zA-Z\200-\377]*') {</span>
<span class="pc" id="L42">            return id</span>
        } else {
<span class="pc" id="L44">            return &quot;\&quot;$id\&quot;&quot;</span>
        }
    }

    @PackageScope
    String getEdgeDot(Edge edge) {
<span class="fc" id="L50">        String string = &quot;${getId(edge.from.toString())} $edgeString ${getId(edge.to.toString())}&quot;</span>
<span class="fc" id="L51">        String attributes = edge.findAll {</span>
<span class="pc bfc" id="L52" title="All 4 branches covered.">            it.key != 'from' &amp;&amp; it.key != 'to'</span>
        }.collect {
<span class="pc" id="L54">            /$it.key=&quot;$it.value&quot;/</span>
        }.join(' ')
<span class="fc bfc" id="L56" title="All 2 branches covered.">        if(attributes) {</span>
<span class="fc" id="L57">            return &quot;$string [$attributes]&quot;</span>
        }
<span class="pc" id="L59">        string</span>
    }

    @PackageScope
    String getVertexDot(Vertex vertex) {
<span class="fc" id="L64">        String string =getId(vertex.id.toString())</span>
<span class="fc" id="L65">        String attributes = vertex.findAll {</span>
<span class="pc" id="L66">            it.key != 'id'</span>
        }.collect {
<span class="pc" id="L68">            /$it.key=&quot;$it.value&quot;/</span>
        }.join(' ')
<span class="fc bfc" id="L70" title="All 2 branches covered.">        if(attributes) {</span>
<span class="fc" id="L71">            return &quot;$string [$attributes]&quot;</span>
        }
<span class="pc" id="L73">        string</span>
    }

    String dot() {
<span class="fc" id="L77">        StringWriter writer = new StringWriter()</span>

<span class="fc" id="L79">        new IndentPrinter(writer).with { p -&gt;</span>
<span class="fc" id="L80">            p.autoIndent = true</span>
<span class="fc" id="L81">            p.println(&quot;$graphString {&quot;)</span>
<span class="fc" id="L82">            p.incrementIndent()</span>
<span class="fc" id="L83">            graph.edges.each {</span>
<span class="pc" id="L84">                p.println(getEdgeDot(it))</span>
            }
<span class="fc" id="L86">            graph.vertices.each { Object id, Vertex v -&gt;</span>
<span class="fc bfc" id="L87" title="All 6 branches covered.">                if(v.size() &gt; 1 || graph.adjacentEdges(id).size() == 0) {</span>
<span class="pc" id="L88">                    p.println(getVertexDot(v))</span>
                }
            }

<span class="fc" id="L92">            p.decrementIndent()</span>
<span class="fc" id="L93">            p.print('}')</span>
<span class="pc" id="L94">            p.flush()</span>
        }

<span class="pc" id="L97">        writer.toString()</span>
    }

    void dot(String file) {
<span class="fc" id="L101">        new File(file).write(dot())</span>
    }

    Map image() {
<span class="nc bnc" id="L105" title="All 2 branches missed.">        Process execute = &quot;${graph.isDirected() ? 'dot' : 'neato'} -Tpng&quot;.execute()</span>
<span class="nc" id="L106">        execute.outputStream.withWriter { writer -&gt;</span>
<span class="nc" id="L107">            writer.write(dot())</span>
        }
<span class="nc" id="L109">        StringBuilder err = new StringBuilder()</span>
<span class="nc" id="L110">        execute.consumeProcessErrorStream(err)</span>

<span class="nc" id="L112">        BufferedImage image = ImageIO.read(execute.inputStream)</span>
<span class="nc" id="L113">        execute.waitFor()</span>

<span class="nc" id="L115">        return [image:image, error:err.toString()]</span>
    }

    void snapshot(int count = 1) {
<span class="nc" id="L119">        (0..count).each {</span>
<span class="nc" id="L120">            snapshots.add(image().image)</span>
        }
    }

    void gif(String file, int delay = 1000, boolean loop = true) throws IOException {
<span class="nc" id="L125">        Map&lt;String, Integer&gt; max = findMaxWidthHeight()</span>
<span class="nc" id="L126">        List&lt;BufferedImage&gt; resized = snapshots.collect {</span>
<span class="nc" id="L127">            int b = guessBackgroundColor(it)</span>
<span class="nc" id="L128">            BufferedImage out = createOutputImage(b, max.width, max.height, it.type)</span>
<span class="nc" id="L129">            centerOnOutput(out, it)</span>
        }
<span class="nc" id="L131">        writeImagesToFileAsGif(new File(file), resized, delay, loop)</span>
    }

    void writeImagesToFileAsGif(File file, List&lt;BufferedImage&gt; images, int delay, boolean loop) {
<span class="nc" id="L135">        new FileImageOutputStream(file).withCloseable { out -&gt;</span>
<span class="nc" id="L136">            GifSequenceWriter writer = new GifSequenceWriter(out, BufferedImage.TYPE_3BYTE_BGR, delay, loop)</span>
<span class="nc" id="L137">            images.each {</span>
<span class="nc" id="L138">                writer.writeToSequence(it)</span>
            }
<span class="nc" id="L140">            writer.close()</span>
        }
    }

    BufferedImage centerOnOutput(BufferedImage output, BufferedImage image) {
<span class="fc" id="L145">        int x = (output.width - image.width) / 2</span>
<span class="fc" id="L146">        int y = (output.height - image.height) / 2</span>
<span class="fc" id="L147">        Graphics2D g2d = output.createGraphics()</span>
<span class="fc" id="L148">        g2d.drawImage(image, x, y, image.width, image.height, null)</span>
<span class="fc" id="L149">        g2d.dispose()</span>
<span class="pc" id="L150">        output</span>
    }

    BufferedImage createOutputImage(int background, int width, int height, int type) {
<span class="fc" id="L154">        BufferedImage out = new BufferedImage(width, height, type)</span>
<span class="fc" id="L155">        Graphics2D g2d = out.createGraphics()</span>
<span class="fc" id="L156">        g2d.setBackground(new Color(background))</span>
<span class="fc" id="L157">        g2d.clearRect(0, 0, width, height)</span>
<span class="fc" id="L158">        g2d.dispose()</span>
<span class="pc" id="L159">        out</span>

    }

    int guessBackgroundColor(BufferedImage image) {
<span class="pc" id="L164">        image.getRGB(0, 0)</span>
    }

    Map&lt;String, Integer&gt; findMaxWidthHeight() {
<span class="fc" id="L168">        Map&lt;String, Integer&gt; max = [:]</span>
<span class="fc" id="L169">        max.width = 0</span>
<span class="fc" id="L170">        max.height = 0</span>
<span class="fc" id="L171">        snapshots.each {</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">            max.width = it.width &gt; max.width ? it.width : max.width</span>
<span class="pc bfc" id="L173" title="All 2 branches covered.">            max.height = it.height &gt; max.height ? it.height : max.height</span>
        }
<span class="pc" id="L175">        max</span>
    }

    void image(String file) {
<span class="nc" id="L179">        new File(file).withOutputStream { out -&gt;</span>
<span class="nc" id="L180">            ImageIO.write(image().image, 'PNG', out)</span>
        }
    }

    void view() {
<span class="nc" id="L185">        Path file = Files.createTempFile('graph', '.png')</span>
<span class="nc" id="L186">        image(file.toString())</span>
<span class="nc" id="L187">        Process execute = &quot;xdg-open $file&quot;.execute()</span>
<span class="nc" id="L188">        StringBuilder err = new StringBuilder()</span>
<span class="nc" id="L189">        execute.consumeProcessErrorStream(err)</span>
<span class="nc" id="L190">        execute.waitFor()</span>
<span class="nc" id="L191">        println err</span>
<span class="nc" id="L192">        Files.delete(file)</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>